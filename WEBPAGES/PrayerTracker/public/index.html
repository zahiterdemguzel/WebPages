<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muslim Prayer Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Tailwind Configuration (optional, but good for consistent palette) */
        :root {
            --color-primary-green: #4CAF50;
            --color-light-green: #8BC34A;
            --color-dark-green: #388E3C;
            --color-accent-green: #66BB6A;
            --color-white: #FFFFFF;
            --color-off-white: #F9FAFB;
            --color-text-dark: #333333;
        }

        /* Applying custom colors to Tailwind classes */
        .bg-primary-green {
            background-color: var(--color-primary-green);
        }

        .bg-light-green {
            background-color: var(--color-light-green);
        }

        .bg-dark-green {
            background-color: var(--color-dark-green);
        }

        .bg-accent-green {
            background-color: var(--color-accent-green);
        }

        .text-primary-green {
            color: var(--color-primary-green);
        }

        .text-dark-green {
            color: var(--color-dark-green);
        }

        .text-text-dark {
            color: var(--color-text-dark);
        }

        .bg-off-white {
            background-color: var(--color-off-white);
        }

        .bg-green-100 {
            background-color: #F0FDF4;
            /* A very light green */
        }

        /* Inter font from Google Fonts */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--color-off-white);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-light-green);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary-green);
        }

        /* Modal specific styles */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1000;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 95%;
            /* Make it take more width on smaller screens */
            max-width: 700px;
            /* Increased max-width for wider modal */
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body class="bg-off-white text-text-dark min-h-screen flex flex-col items-center p-4 sm:p-6">
    <div class="max-w-4xl w-full bg-white rounded-xl shadow-lg p-6 sm:p-8 space-y-8">

        <header
            class="text-center pb-4 border-b border-gray-200 flex flex-col sm:flex-row sm:justify-between sm:items-center p-4">
            <div class="flex justify-center sm:justify-start w-full sm:w-auto order-2 sm:order-1 mb-2 sm:mb-0">
                <button id="settingsButton"
                    class="bg-blue-500 text-white px-4 py-2 rounded-full shadow-md hover:bg-blue-600 transition-colors duration-200 hidden">
                    <i class="fas fa-cog mr-2"></i>Settings
                </button>
            </div>
            <div class="text-center sm:flex-grow w-full sm:w-auto order-1 sm:order-2">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-dark-green mb-2">
                    <i class="fas fa-mosque mr-3 text-primary-green"></i>Prayer Tracker
                </h1>
                <p class="text-lg text-gray-600">Track your daily prayers with ease.</p>
                <p id="loggedInUser" class="text-sm text-gray-700 mt-2 hidden">Logged in as: <span
                        class="font-semibold"></span></p>
                <p id="userIdDisplay" class="text-xs text-gray-500 mt-1 hidden">User ID: <span
                        class="font-mono text-gray-600"></span></p>
            </div>
            <div class="flex justify-center sm:justify-end mt-2 sm:mt-0 space-x-2 order-3 sm:order-3">
                <button id="authButton"
                    class="bg-primary-green text-white px-4 py-2 rounded-full shadow-md hover:bg-dark-green transition-colors duration-200">
                    Login / Register
                </button>
                <button id="logoutButton"
                    class="bg-red-500 text-white px-4 py-2 rounded-full shadow-md hover:bg-red-600 transition-colors duration-200 hidden">
                    Logout
                </button>
            </div>
        </header>

        <div class="flex items-center justify-between bg-primary-green text-white p-4 rounded-lg shadow-md">
            <button id="prevDayBtn" class="p-2 rounded-full hover:bg-light-green transition-colors duration-200">
                <i class="fas fa-chevron-left text-xl"></i>
            </button>
            <h2 id="currentDateDisplay"
                class="text-2xl font-semibold text-center flex-grow min-w-0 whitespace-nowrap overflow-hidden text-ellipsis sm:text-2xl md:text-3xl">
            </h2>
            <button id="nextDayBtn" class="p-2 rounded-full hover:bg-light-green transition-colors duration-200">
                <i class="fas fa-chevron-right text-xl"></i>
            </button>
        </div>

        <div id="prayerList" class="flex flex-col gap-6 w-full">
            <div id="mainPrayersRow"
                class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-5 gap-4 place-items-center">
            </div>
            <div id="optionalPrayersRow"
                class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-5 gap-4 mt-4 place-items-center">
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-200">
            <h3 class="text-2xl font-bold text-dark-green mb-4 text-center">Monthly Overview</h3>
            <div class="flex justify-center mb-4">
                <button id="todayButton"
                    class="bg-accent-green text-white px-4 py-2 rounded-full shadow-md hover:bg-primary-green transition-colors duration-200">
                    <i class="fas fa-calendar-day mr-2"></i>Today
                </button>
            </div>
            <div id="monthlyOverview" class="grid grid-cols-7 gap-1 text-sm text-center">
                <div class="font-semibold text-primary-green">Sun</div>
                <div class="font-semibold text-primary-green">Mon</div>
                <div class="font-semibold text-primary-green">Tue</div>
                <div class="font-semibold text-primary-green">Wed</div>
                <div class="font-semibold text-primary-green">Thu</div>
                <div class="font-semibold text-primary-green">Fri</div>
                <div class="font-semibold text-primary-green">Sat</div>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-200 text-center">
            <button id="statsButton"
                class="bg-indigo-500 text-white px-6 py-3 rounded-full shadow-md hover:bg-indigo-600 transition-colors duration-200 text-lg font-semibold hidden">
                <i class="fas fa-chart-bar mr-2"></i>View Statistics
            </button>
        </div>

        <footer class="mt-8 pt-6 border-t border-gray-200 text-center text-gray-500 text-sm">
            <p>
                <i class="fas fa-info-circle mr-1"></i>
                This application uses a Node.js backend with MongoDB for user management and data storage.
                Ensure your Node.js server is running on <span class="font-semibold">http://localhost:3000</span>.
            </p>
        </footer>

    </div>

    <div id="authModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeAuthModalBtn">&times;</span>
            <h2 class="text-3xl font-bold text-dark-green mb-6 text-center" id="modalTitle">Login</h2>

            <form id="authForm" class="space-y-4">
                <div>
                    <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="email" name="email"
                        class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-primary-green"
                        placeholder="Enter your email" required>
                </div>
                <div>
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="password" name="password"
                        class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-primary-green"
                        placeholder="Enter your password" required>
                </div>
                <p id="authMessage" class="text-red-500 text-sm italic text-center"></p>
                <button type="submit" id="submitAuthBtn"
                    class="bg-primary-green hover:bg-dark-green text-white font-bold py-3 px-6 rounded-full w-full transition-colors duration-200 shadow-md">
                    Login
                </button>
            </form>
            <div class="text-center mt-4">
                <button id="toggleAuthMode" class="text-primary-green hover:text-dark-green text-sm font-semibold">
                    Don't have an account? Register here.
                </button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeSettingsModalBtn">&times;</span>
            <h2 class="text-3xl font-bold text-dark-green mb-6 text-center">Settings</h2>

            <div class="space-y-4">
                <div>
                    <label for="newOptionalPrayer" class="block text-gray-700 text-sm font-bold mb-2">Add Optional
                        Prayer:</label>
                    <input type="text" id="newOptionalPrayer"
                        class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-primary-green"
                        placeholder="e.g., Duha, Witr">
                    <button id="addOptionalPrayerBtn"
                        class="mt-3 bg-accent-green hover:bg-primary-green text-white font-bold py-2 px-4 rounded-full w-full transition-colors duration-200 shadow-md">
                        Add Prayer
                    </button>
                    <p id="settingsMessage" class="text-red-500 text-sm italic text-center mt-2"></p>
                </div>
                <div class="mt-6">
                    <h3 class="text-xl font-semibold text-dark-green mb-3">Your Optional Prayers:</h3>
                    <ul id="optionalPrayersList" class="space-y-2">
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="statsModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeStatsModalBtn">&times;</span>
            <h2 class="text-3xl font-bold text-dark-green mb-6 text-center">Prayer Statistics</h2>

            <div class="space-y-6">
                <div>
                    <h3 class="text-xl font-semibold text-dark-green mb-2">Overall Prayer Rate:</h3>
                    <p id="overallRate" class="text-2xl font-bold text-primary-green text-center">--%</p>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-dark-green mb-2">Individual Prayer Rates:</h3>
                    <ul id="individualRatesList" class="space-y-2">
                    </ul>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-dark-green mb-2">Prayer by Day of Week:</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Day
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="dayOfWeekStatsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <p id="statsMessage" class="text-red-500 text-sm italic text-center mt-2"></p>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Global Variables and Constants ---
        const PRAYER_NAMES = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha']; // Mandatory prayers
        let currentSelectedDate = new Date(); // Tracks the date currently displayed
        let prayerData = {}; // Stores all prayer data, keyed byYYYY-MM-DD
        let currentUserId = localStorage.getItem('userId'); // Get from localStorage
        let currentUsername = localStorage.getItem('username'); // Get from localStorage
        let authToken = localStorage.getItem('authToken'); // Get from localStorage
        let userSettings = { optionalPrayers: [] }; // Stores user-specific settings like optional prayers

        const API_BASE_URL = 'http://localhost:3000/api';  // Your Node.js server URL

        // --- DOM Elements ---
        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const prevDayBtn = document.getElementById('prevDayBtn');
        const nextDayBtn = document.getElementById('nextDayBtn');
        const monthlyOverviewContainer = document.getElementById('monthlyOverview');
        const todayButton = document.getElementById('todayButton');

        // Prayer List Containers
        const mainPrayersRow = document.getElementById('mainPrayersRow');
        const optionalPrayersRow = document.getElementById('optionalPrayersRow');

        // Auth Modal Elements
        const authModal = document.getElementById('authModal');
        const closeAuthModalBtn = document.getElementById('closeAuthModalBtn');
        const authButton = document.getElementById('authButton');
        const logoutButton = document.getElementById('logoutButton');
        const authForm = document.getElementById('authForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authMessage = document.getElementById('authMessage');
        const modalTitle = document.getElementById('modalTitle');
        const submitAuthBtn = document.getElementById('submitAuthBtn');
        const toggleAuthModeBtn = document.getElementById('toggleAuthMode');
        const loggedInUserDisplay = document.getElementById('loggedInUser');
        const loggedInUsernameSpan = loggedInUserDisplay.querySelector('span');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const userIdSpan = userIdDisplay.querySelector('span');

        let isLoginMode = true; // State for login/register modal

        // Settings Modal Elements
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
        const newOptionalPrayerInput = document.getElementById('newOptionalPrayer');
        const addOptionalPrayerBtn = document.getElementById('addOptionalPrayerBtn');
        const optionalPrayersList = document.getElementById('optionalPrayersList');
        const settingsMessage = document.getElementById('settingsMessage'); // For displaying messages in settings modal

        // Stats Modal Elements
        const statsButton = document.getElementById('statsButton'); // New: Stats button
        const statsModal = document.getElementById('statsModal'); // New: Stats modal
        const closeStatsModalBtn = document.getElementById('closeStatsModalBtn'); // New: Close stats modal button
        const overallRateDisplay = document.getElementById('overallRate'); // New: Overall rate display
        const individualRatesList = document.getElementById('individualRatesList'); // New: Individual rates list
        const dayOfWeekStatsTableBody = document.getElementById('dayOfWeekStatsTableBody'); // New: Day of week table body
        const statsMessage = document.getElementById('statsMessage'); // New: Stats message

        // --- Utility Functions ---

        /**
         * Formats a Date object into aYYYY-MM-DD string.
         * @param {Date} date - The date object to format.
         * @returns {string} Formatted date string.
         */
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Formats a Date object into a human-readable string (e.g., "Monday, Jan 1, 2024").
         * @param {Date} date - The date object to format.
         * @returns {string} Human-readable date string.
         */
        function formatDisplayDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        /**
         * Fetches all prayer data for the current user from the backend.
         * This is used for statistics calculation.
         * @returns {Promise<Object>} A promise that resolves with all prayer data.
         */
        async function loadAllPrayerDataForStats() {
            if (!currentUserId || !authToken) {
                return {};
            }
            try {
                const response = await fetch(`${API_BASE_URL}/prayers/${currentUserId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        console.error("Authentication error loading all prayer data for stats. Logging out.");
                        logoutUser();
                        return {};
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Error loading all prayer data for stats:", error);
                return {};
            }
        }

        /**
         * Fetches prayer data for the currently selected date from the backend.
         */
        async function loadPrayerData() {
            if (!currentUserId || !authToken) {
                prayerData = {}; // Clear data if no user or no token
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/prayers/${currentUserId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        console.error("Authentication error loading prayer data. Logging out.");
                        logoutUser(); // Log out if token is invalid/expired
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                prayerData = await response.json();
            } catch (error) {
                console.error("Error loading prayer data:", error);
                prayerData = {}; // Reset to empty on error
            } finally {
                renderPrayerCards();
                renderMonthlyOverview();
            }
        }

        /**
         * Saves prayer data to the backend.
         * @param {string} dateStr - The date string (YYYY-MM-DD) for which to save data.
         * @param {Object} dailyData - The prayer data for that specific date.
         */
        async function savePrayerData(dateStr, dailyData) {
            if (!currentUserId || !authToken) {
                console.warn("Cannot save prayer data: No user logged in or no token.");
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/prayers/${currentUserId}/${dateStr}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(dailyData)
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        console.error("Authentication error saving prayer data. Logging out.");
                        logoutUser();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (e) {
                console.error("Error saving prayer data:", e);
            }
        }

        /**
         * Fetches user settings from the backend.
         */
        async function loadUserSettings() {
            if (!currentUserId || !authToken) {
                userSettings = { optionalPrayers: [] }; // Reset settings if no user or no token
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/settings/${currentUserId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        console.error("Authentication error loading user settings. Logging out.");
                        logoutUser();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                userSettings = data;
                if (!userSettings.optionalPrayers) {
                    userSettings.optionalPrayers = []; // Ensure optionalPrayers array exists
                }
            } catch (e) {
                console.error("Error loading user settings:", e);
                userSettings = { optionalPrayers: [] }; // Reset to default on error
            } finally {
                renderPrayerCards(); // Re-render prayer cards as optional prayers might have changed
                renderMonthlyOverview(); // Re-render monthly overview
                renderOptionalPrayersListInSettings(); // Update settings modal list
            }
        }

        /**
         * Saves user settings to the backend.
         */
        async function saveUserSettings() {
            if (!currentUserId || !authToken) {
                console.warn("Cannot save user settings: No user logged in or no token.");
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/settings/${currentUserId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(userSettings)
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        console.error("Authentication error saving user settings. Logging out.");
                        logoutUser();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (e) {
                console.error("Error saving user settings:", e);
            }
        }

        /**
         * Initializes prayer status for a given date if it doesn't exist, including optional prayers.
         * This function now primarily ensures the structure, actual data comes from the backend.
         * @param {string} dateStr - The date string (YYYY-MM-DD).
         */
        function initializeDailyPrayers(dateStr) {
            if (!prayerData[dateStr]) {
                prayerData[dateStr] = {};
            }
            // Ensure all mandatory prayers are present in the current day's data, default to false
            PRAYER_NAMES.forEach(prayer => {
                if (typeof prayerData[dateStr][prayer] === 'undefined') {
                    prayerData[dateStr][prayer] = false;
                }
            });
            // Ensure all optional prayers are present, default to false
            if (userSettings.optionalPrayers) {
                userSettings.optionalPrayers.forEach(prayer => {
                    if (typeof prayerData[dateStr][prayer] === 'undefined') {
                        prayerData[dateStr][prayer] = false;
                    }
                });
            }
        }

        /**
         * Creates a prayer card DOM element.
         * @param {string} prayerName - The name of the prayer.
         * @param {boolean} isPrayed - Whether the prayer is marked as prayed.
         * @returns {HTMLElement} The created prayer card div.
         */
        function createPrayerCard(prayerName, isPrayed) {
            const card = document.createElement('div');
            // Adjusted width classes to help prayers fit on one row on larger screens
            // Adjusted lg:w-40 and added xl:w-40 to ensure 5 columns on larger screens
            card.className = `
                flex-shrink-0 w-32 sm:w-36 md:w-40 lg:w-40 xl:w-40 rounded-xl shadow-md p-4 flex flex-col items-center justify-center
                transition-all duration-300 transform hover:scale-105 cursor-pointer
                ${isPrayed ? 'bg-green-100 border-4 border-primary-green' : 'bg-white border-2 border-gray-200'}
            `;
            card.dataset.prayerName = prayerName;

            card.innerHTML = `
                <div class="text-4xl mb-3 ${isPrayed ? 'text-primary-green' : 'text-gray-400'}">
                    <i class="fas fa-hands-praying"></i>
                </div>
                <h3 class="text-xl font-semibold mb-2 text-dark-green text-center">${prayerName}</h3>
                <span class="text-md ${isPrayed ? 'text-primary-green font-bold' : 'text-gray-500'} flex items-center">
                    ${isPrayed ? 'Prayed <i class="fas fa-check-circle ml-2 text-primary-green"></i>' : 'Not Prayed'}
                </span>
                <button class="mt-3 px-4 py-2 text-sm rounded-full text-white font-medium
                                ${isPrayed ? 'bg-red-500 hover:bg-red-600' : 'bg-primary-green hover:bg-dark-green'}
                                transition-colors duration-200 shadow-md">
                    ${isPrayed ? 'Mark Unprayed' : 'Mark Prayed'}
                </button>
            `;

            // Add event listener to the button within the card
            const button = card.querySelector('button');
            button.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent card click event from firing
                togglePrayerStatus(prayerName);
            });

            // Add event listener to the card itself (for clicking anywhere on the card)
            card.addEventListener('click', () => {
                togglePrayerStatus(prayerName);
            });

            return card;
        }

        /**
         * Renders the prayer cards for the currently selected date.
         */
        function renderPrayerCards() {
            mainPrayersRow.innerHTML = ''; // Clear previous cards
            optionalPrayersRow.innerHTML = '';
            optionalPrayersRow.classList.add('hidden'); // Hide optional row by default

            if (!currentUserId) {
                mainPrayersRow.innerHTML = `
                    <div class="col-span-full text-center p-8 bg-gray-50 rounded-lg text-gray-600 w-full">
                        Please login or register to start tracking your prayers.
                    </div>
                `;
                return;
            }

            const dateStr = formatDate(currentSelectedDate);
            initializeDailyPrayers(dateStr); // Ensure data structure exists for the current day

            // Render Main Prayers
            PRAYER_NAMES.forEach(prayer => {
                const isPrayed = prayerData[dateStr] ? prayerData[dateStr][prayer] : false;
                mainPrayersRow.appendChild(createPrayerCard(prayer, isPrayed));
            });

            // Render Optional Prayers if any
            if (userSettings.optionalPrayers && userSettings.optionalPrayers.length > 0) {
                optionalPrayersRow.classList.remove('hidden'); // Show optional row
                userSettings.optionalPrayers.forEach(prayer => {
                    const isPrayed = prayerData[dateStr] ? prayerData[dateStr][prayer] : false;
                    optionalPrayersRow.appendChild(createPrayerCard(prayer, isPrayed));
                });
            }
        }

        /**
         * Toggles the prayer status for a specific prayer on the current date.
         * @param {string} prayerName - The name of the prayer (e.g., 'Fajr').
         */
        async function togglePrayerStatus(prayerName) {
            if (!currentUserId) {
                authMessage.textContent = "Please login to track prayers.";
                authModal.classList.remove('hidden');
                return;
            }
            const dateStr = formatDate(currentSelectedDate);
            initializeDailyPrayers(dateStr); // Ensure data structure exists

            // Toggle the status locally first for immediate UI feedback
            prayerData[dateStr][prayerName] = !prayerData[dateStr][prayerName];
            renderPrayerCards(); // Re-render immediately

            // Save the updated data to the backend
            await savePrayerData(dateStr, prayerData[dateStr]);
            renderMonthlyOverview(); // Update monthly view
        }

        /**
         * Renders the monthly overview calendar.
         */
        function renderMonthlyOverview() {
            monthlyOverviewContainer.innerHTML = `
                <div class="font-semibold text-primary-green">Sun</div>
                <div class="font-semibold text-primary-green">Mon</div>
                <div class="font-semibold text-primary-green">Tue</div>
                <div class="font-semibold text-primary-green">Wed</div>
                <div class="font-semibold text-primary-green">Thu</div>
                <div class="font-semibold text-primary-green">Fri</div>
                <div class="font-semibold text-primary-green">Sat</div>
            `; // Reset and add day headers

            if (!currentUserId) {
                // Clear calendar if not logged in
                return;
            }

            const today = new Date();
            const year = currentSelectedDate.getFullYear();
            const month = currentSelectedDate.getMonth();

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const numDaysInMonth = lastDayOfMonth.getDate();

            // Calculate offset for the first day of the month (0 = Sunday, 6 = Saturday)
            const startDay = firstDayOfMonth.getDay();

            // Add empty divs for days before the 1st of the month
            for (let i = 0; i < startDay; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'p-2';
                monthlyOverviewContainer.appendChild(emptyDiv);
            }

            // Combine all prayer names for monthly overview calculation
            const allPrayerNames = [...PRAYER_NAMES, ...(userSettings.optionalPrayers || [])];

            // Add actual days
            for (let day = 1; day <= numDaysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDate(date);
                initializeDailyPrayers(dateStr); // Ensure data exists for this day

                const dailyPrayers = prayerData[dateStr] || {}; // Get daily data, default to empty object
                const prayedCount = allPrayerNames.filter(p => dailyPrayers[p]).length;
                const totalPrayers = allPrayerNames.length;
                const allPrayed = totalPrayers > 0 && prayedCount === totalPrayers;
                const anyPrayed = prayedCount > 0;

                const dayDiv = document.createElement('div');
                dayDiv.className = `
                    p-2 rounded-lg cursor-pointer transition-colors duration-200 text-center
                    ${allPrayed ? 'bg-primary-green text-white font-bold shadow-md' :
                        anyPrayed ? 'bg-light-green text-white shadow-sm' :
                            'bg-gray-100 text-gray-700 hover:bg-gray-200'}
                    ${dateStr === formatDate(today) ? 'border-2 border-dark-green' : ''}
                    ${dateStr === formatDate(currentSelectedDate) ? 'ring-2 ring-accent-green ring-offset-2' : ''}
                `;
                dayDiv.textContent = day;
                dayDiv.dataset.date = dateStr;

                // Add tooltip for prayer status
                dayDiv.title = `${formatDisplayDate(date)}\n${prayedCount}/${totalPrayers} prayers completed`;

                dayDiv.addEventListener('click', () => {
                    currentSelectedDate = date;
                    updateUI();
                });
                monthlyOverviewContainer.appendChild(dayDiv);
            }
        }

        /**
         * Updates the UI elements based on the currentSelectedDate and user login status.
         */
        async function updateUI() {
            currentDateDisplay.textContent = formatDisplayDate(currentSelectedDate);
            updateAuthUI();
            await loadUserSettings(); // Load settings first
            await loadPrayerData(); // Then load prayer data
        }

        /**
         * Updates the visibility of auth buttons and user display.
         */
        function updateAuthUI() {
            if (currentUserId && authToken) {
                authButton.classList.add('hidden');
                logoutButton.classList.remove('hidden');
                settingsButton.classList.remove('hidden'); // Show settings button when logged in
                statsButton.classList.remove('hidden'); // Show stats button when logged in
                loggedInUserDisplay.classList.remove('hidden');
                userIdDisplay.classList.remove('hidden');
                loggedInUsernameSpan.textContent = currentUsername;
                userIdSpan.textContent = currentUserId; // Display full user ID
            } else {
                authButton.classList.remove('hidden');
                logoutButton.classList.add('hidden');
                settingsButton.classList.add('hidden'); // Hide settings button when logged out
                statsButton.classList.add('hidden'); // Hide stats button when logged out
                loggedInUserDisplay.classList.add('hidden');
                userIdDisplay.classList.add('hidden');
                loggedInUsernameSpan.textContent = '';
                userIdSpan.textContent = '';
            }
        }

        // --- Authentication Functions (Custom Backend) ---

        /**
         * Handles user login with custom backend.
         */
        async function loginUser(email, password) {
            authMessage.textContent = 'Logging in...';
            authMessage.classList.remove('text-primary-green');
            authMessage.classList.add('text-red-500');
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('userId', data.userId);
                    localStorage.setItem('username', data.email); // Store email as username
                    authToken = data.token;
                    currentUserId = data.userId;
                    currentUsername = data.email;
                    authModal.classList.add('hidden');
                    authMessage.textContent = '';
                    await updateUI(); // Load data and update UI after successful login
                } else {
                    authMessage.textContent = data.message || 'Login failed.';
                }
            }
            catch (error) {
                console.error("Login error:", error);
                authMessage.textContent = 'An error occurred during login. Is the server running?';
            }
        }

        /**
         * Handles user registration with custom backend.
         */
        async function registerUser(email, password) {
            authMessage.textContent = 'Registering...';
            authMessage.classList.remove('text-primary-green');
            authMessage.classList.add('text-red-500');
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('userId', data.userId);
                    localStorage.setItem('username', data.email); // Store email as username
                    authToken = data.token;
                    currentUserId = data.userId;
                    currentUsername = data.email;
                    authModal.classList.add('hidden');
                    authMessage.textContent = '';
                    await updateUI(); // Load data and update UI after successful registration
                } else {
                    authMessage.textContent = data.message || 'Registration failed.';
                }
            }
            catch (error) {
                console.error("Registration error:", error);
                authMessage.textContent = 'An error occurred during registration. Is the server running?';
            }
        }

        /**
         * Handles user logout.
         */
        function logoutUser() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            authToken = null;
            currentUserId = null;
            currentUsername = null;
            prayerData = {}; // Clear local prayer data on logout
            userSettings = { optionalPrayers: [] }; // Clear local settings on logout
            updateUI(); // Update UI to logged-out state
            authMessage.textContent = 'Logged out successfully.';
            authMessage.classList.remove('text-red-500');
            authMessage.classList.add('text-primary-green');
            authModal.classList.remove('hidden'); // Show login modal after logout
        }

        // --- Settings Functions ---

        /**
         * Adds a new optional prayer to user settings.
         * @param {string} prayerName - The name of the optional prayer.
         */
        async function addOptionalPrayer(prayerName) {
            if (!currentUserId) {
                settingsMessage.textContent = "Please login to add optional prayers.";
                settingsMessage.classList.remove('text-primary-green');
                settingsMessage.classList.add('text-red-500');
                return;
            }
            if (!prayerName) {
                settingsMessage.textContent = "Prayer name cannot be empty.";
                settingsMessage.classList.remove('text-primary-green');
                settingsMessage.classList.add('text-red-500');
                return;
            }

            const normalizedPrayerName = prayerName.trim();

            if (!userSettings.optionalPrayers) {
                userSettings.optionalPrayers = [];
            }

            // Prevent duplicates (case-insensitive check)
            if (!userSettings.optionalPrayers.some(p => p.toLowerCase() === normalizedPrayerName.toLowerCase())) {
                userSettings.optionalPrayers.push(normalizedPrayerName);
                await saveUserSettings();
                newOptionalPrayerInput.value = ''; // Clear input
                settingsMessage.textContent = `"${normalizedPrayerName}" added successfully.`;
                settingsMessage.classList.remove('text-red-500');
                settingsMessage.classList.add('text-primary-green');
                renderOptionalPrayersListInSettings(); // Refresh the list in the settings modal
                await updateUI(); // Re-render main prayer cards and monthly overview
            } else {
                settingsMessage.textContent = `"${normalizedPrayerName}" already exists!`;
                settingsMessage.classList.remove('text-primary-green');
                settingsMessage.classList.add('text-red-500');
            }
        }

        /**
         * Removes an optional prayer from user settings.
         * @param {string} prayerName - The name of the optional prayer to remove.
         */
        async function removeOptionalPrayer(prayerName) {
            if (!currentUserId) {
                settingsMessage.textContent = "Please login to remove optional prayers.";
                settingsMessage.classList.remove('text-primary-green');
                settingsMessage.classList.add('text-red-500');
                return;
            }
            if (!userSettings.optionalPrayers) return;

            userSettings.optionalPrayers = userSettings.optionalPrayers.filter(p => p !== prayerName);
            await saveUserSettings();
            settingsMessage.textContent = `"${prayerName}" removed.`;
            settingsMessage.classList.remove('text-red-500');
            settingsMessage.classList.add('text-primary-green');
            renderOptionalPrayersListInSettings(); // Refresh the list in the settings modal
            await updateUI(); // Re-render main prayer cards and monthly overview
        }

        /**
         * Renders the list of optional prayers in the settings modal.
         */
        function renderOptionalPrayersListInSettings() {
            optionalPrayersList.innerHTML = '';
            if (userSettings.optionalPrayers && userSettings.optionalPrayers.length > 0) {
                userSettings.optionalPrayers.forEach(prayer => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg shadow-sm';
                    listItem.innerHTML = `
                        <span class="text-gray-800 font-medium">${prayer}</span>
                        <button class="text-red-500 hover:text-red-700 transition-colors duration-200" data-prayer="${prayer}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    optionalPrayersList.appendChild(listItem);

                    listItem.querySelector('button').addEventListener('click', (event) => {
                        removeOptionalPrayer(event.currentTarget.dataset.prayer);
                    });
                });
            } else {
                optionalPrayersList.innerHTML = '<li class="text-gray-500 text-center">No optional prayers added yet.</li>';
            }
        }

        // --- Statistics Functions ---

        /**
         * Calculates and renders prayer statistics.
         */
        async function calculateAndRenderStats() {
            statsMessage.textContent = ''; // Clear previous messages
            overallRateDisplay.textContent = '--%';
            individualRatesList.innerHTML = '';
            dayOfWeekStatsTableBody.innerHTML = '';

            if (!currentUserId) {
                statsMessage.textContent = "Please login to view statistics.";
                statsModal.classList.remove('hidden');
                return;
            }

            const allPrayerRecords = await loadAllPrayerDataForStats();
            const allPrayerNames = [...PRAYER_NAMES, ...(userSettings.optionalPrayers || [])];

            let totalPrayersCompleted = 0;
            let totalPossiblePrayers = 0;
            const individualPrayerCounts = {}; // { prayerName: { completed: 0, possible: 0 } }
            const dayOfWeekCounts = { // { dayName: { prayerName: { completed: 0, possible: 0 } } }
                "Sunday": {}, "Monday": {}, "Tuesday": {}, "Wednesday": {},
                "Thursday": {}, "Friday": {}, "Saturday": {}
            };
            const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

            // Initialize counts
            allPrayerNames.forEach(p => {
                individualPrayerCounts[p] = { completed: 0, possible: 0 };
            });
            daysOfWeek.forEach(day => {
                allPrayerNames.forEach(p => {
                    dayOfWeekCounts[day][p] = { completed: 0, possible: 0 };
                });
            });

            // Process all prayer records
            for (const dateStr in allPrayerRecords) {
                const dailyPrayers = allPrayerRecords[dateStr];
                const date = new Date(dateStr);
                const dayName = daysOfWeek[date.getDay()];

                allPrayerNames.forEach(prayer => {
                    const isPrayed = dailyPrayers[prayer] === true; // Ensure boolean

                    // Overall stats
                    totalPossiblePrayers++;
                    if (isPrayed) {
                        totalPrayersCompleted++;
                    }

                    // Individual stats
                    individualPrayerCounts[prayer].possible++;
                    if (isPrayed) {
                        individualPrayerCounts[prayer].completed++;
                    }

                    // Day of week stats
                    dayOfWeekCounts[dayName][prayer].possible++;
                    if (isPrayed) {
                        dayOfWeekCounts[dayName][prayer].completed++;
                    }
                });
            }

            // Render Overall Rate
            const overallPercentage = totalPossiblePrayers > 0
                ? ((totalPrayersCompleted / totalPossiblePrayers) * 100).toFixed(1)
                : 0;
            overallRateDisplay.textContent = `${overallPercentage}%`;

            // Render Individual Prayer Rates
            if (allPrayerNames.length === 0) {
                individualRatesList.innerHTML = '<li class="text-gray-500">No prayers tracked yet.</li>';
            } else {
                allPrayerNames.forEach(prayer => {
                    const stats = individualPrayerCounts[prayer];
                    const percentage = stats.possible > 0
                        ? ((stats.completed / stats.possible) * 100).toFixed(1)
                        : 0;
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-lg';
                    listItem.innerHTML = `
                        <span class="font-medium">${prayer}:</span>
                        <span class="font-semibold text-primary-green">${percentage}% (${stats.completed}/${stats.possible})</span>
                    `;
                    individualRatesList.appendChild(listItem);
                });
            }

            // Render Day of Week Stats Table
            const tableHeadRow = dayOfWeekStatsTableBody.previousElementSibling.querySelector('tr');
            // Clear existing prayer headers
            tableHeadRow.querySelectorAll('.prayer-header').forEach(el => el.remove());

            // Add dynamic prayer headers
            allPrayerNames.forEach(prayer => {
                const th = document.createElement('th');
                // Adjusted padding for prayer headers in the table
                th.className = 'py-2 px-2 border-b text-center text-sm font-semibold text-gray-600 prayer-header';
                th.textContent = prayer;
                tableHeadRow.appendChild(th);
            });

            if (Object.keys(allPrayerRecords).length === 0) {
                dayOfWeekStatsTableBody.innerHTML = '<tr><td colspan="8" class="py-4 text-center text-gray-500">No prayer data available for statistics.</td></tr>';
            } else {
                daysOfWeek.forEach(day => {
                    const row = document.createElement('tr');
                    row.className = 'border-b last:border-b-0';
                    row.innerHTML = `<td class="py-2 px-4">${day}</td>`;
                    allPrayerNames.forEach(prayer => {
                        const stats = dayOfWeekCounts[day][prayer];
                        const percentage = stats.possible > 0
                            ? ((stats.completed / stats.possible) * 100).toFixed(0) // Round to whole number for table
                            : 0;
                        row.innerHTML += `<td class="py-2 px-2 text-center">${percentage}%</td>`; // Adjusted padding for data cells
                    });
                    dayOfWeekStatsTableBody.appendChild(row);
                });
            }
        }


        // --- Event Listeners ---

        prevDayBtn.addEventListener('click', () => {
            if (currentUserId) { // Only allow navigation if logged in
                currentSelectedDate.setDate(currentSelectedDate.getDate() - 1);
                updateUI();
            } else {
                authMessage.textContent = "Please login to navigate dates.";
                authModal.classList.remove('hidden');
            }
        });

        nextDayBtn.addEventListener('click', () => {
            if (currentUserId) { // Only allow navigation if logged in
                currentSelectedDate.setDate(currentSelectedDate.getDate() + 1);
                updateUI();
            } else {
                authMessage.textContent = "Please login to navigate dates.";
                authModal.classList.remove('hidden');
            }
        });

        todayButton.addEventListener('click', () => {
            if (currentUserId) {
                currentSelectedDate = new Date(); // Set to current date
                updateUI();
            } else {
                authMessage.textContent = "Please login to use the 'Today' button.";
                authModal.classList.remove('hidden');
            }
        });

        authButton.addEventListener('click', () => {
            isLoginMode = true;
            modalTitle.textContent = 'Login';
            submitAuthBtn.textContent = 'Login';
            toggleAuthModeBtn.textContent = "Don't have an account? Register here.";
            authMessage.textContent = ''; // Clear previous messages
            authForm.reset(); // Clear form fields
            authModal.classList.remove('hidden');
        });

        logoutButton.addEventListener('click', logoutUser);

        closeAuthModalBtn.addEventListener('click', () => {
            authModal.classList.add('hidden');
            authMessage.textContent = ''; // Clear message on close
        });

        // Close auth modal if clicked outside content
        authModal.addEventListener('click', (event) => {
            if (event.target === authModal) {
                authModal.classList.add('hidden');
                authMessage.textContent = '';
            }
        });

        toggleAuthModeBtn.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent form submission if this is a button inside a form
            isLoginMode = !isLoginMode;
            modalTitle.textContent = isLoginMode ? 'Login' : 'Register';
            submitAuthBtn.textContent = isLoginMode ? 'Login' : 'Register';
            toggleAuthModeBtn.textContent = isLoginMode ? "Don't have an account? Register here." : "Already have an account? Login here.";
            authMessage.textContent = ''; // Clear message on mode switch
            authForm.reset(); // Clear form fields
        });

        authForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                authMessage.textContent = 'Please enter both email and password.';
                return;
            }

            if (isLoginMode) {
                await loginUser(email, password);
            } else {
                await registerUser(email, password);
            }
        });

        // Settings Modal Event Listeners
        settingsButton.addEventListener('click', () => {
            if (currentUserId) {
                renderOptionalPrayersListInSettings();
                settingsMessage.textContent = ''; // Clear message on open
                settingsModal.classList.remove('hidden');
            }
        });

        closeSettingsModalBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
            settingsMessage.textContent = ''; // Clear message on close
        });

        settingsModal.addEventListener('click', (event) => {
            if (event.target === settingsModal) {
                settingsModal.classList.add('hidden');
                settingsMessage.textContent = '';
            }
        });

        addOptionalPrayerBtn.addEventListener('click', () => {
            const prayerName = newOptionalPrayerInput.value.trim();
            if (prayerName) {
                addOptionalPrayer(prayerName);
            }
        });

        // New: Stats button and modal event listeners
        statsButton.addEventListener('click', async () => {
            if (currentUserId) {
                statsModal.classList.remove('hidden');
                await calculateAndRenderStats();
            } else {
                authMessage.textContent = "Please login to view statistics.";
                authModal.classList.remove('hidden');
            }
        });

        closeStatsModalBtn.addEventListener('click', () => {
            statsModal.classList.add('hidden');
            statsMessage.textContent = ''; // Clear message on close
        });

        statsModal.addEventListener('click', (event) => {
            if (event.target === statsModal) {
                statsModal.classList.add('hidden');
                statsMessage.textContent = '';
            }
        });

        // --- Initialization ---

        /**
         * Initializes the application on page load.
         */
        function init() {
            // Check for existing login session
            if (currentUserId && authToken) {
                updateUI(); // If logged in, load data and update UI
            } else {
                // If not logged in, show login modal and clear prayer list
                authModal.classList.remove('hidden');
                renderPrayerCards(); // Render empty cards
                renderMonthlyOverview(); // Render empty monthly overview
                updateAuthUI();
            }
        }

        // Run initialization when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>